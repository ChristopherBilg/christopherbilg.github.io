<!DOCTYPE html>
<html lang="en" color-mode="user">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content="Christopher Bilger's Portfolio" />
    <meta name="keywords" content="Resume, Portfolio, Personal, Projects, Presentations" />
    <meta name="author" content="Christopher Bilger" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>JS Page Visibility</title>
    <link rel="icon" type="image/x-icon" href="../../images/favicon.ico" />
    <link rel="stylesheet" media="screen" href="../../css/mvp.css" />
    <link rel="stylesheet" media="screen" href="../../css/styles.css" />
  </head>

  <body>
    <noscript id="full-screen-noscript-message">Please enable JavaScript in order to view this webpage.</noscript>

    <main hidden>
      <a href="/projects">Back to Projects List</a>

      <h1>JS Page Visibility</h1>

      <p>
        A simple demo of the <b>Page Visibility API</b> being used to play chimes. This API can be used to determine
        whether a webpage is currently visible to the user or not. This can be useful for pausing animations or videos
        when the user is not actively viewing the page.
      </p>
    </main>

    <script type="module">
      import * as Arlo from "../../js/arlo/index.js";

      for (const exportedName in Arlo) {
        window[exportedName] = Arlo[exportedName];
      }

      (() => {
        document.getElementsByTagName("main")[0].hidden = false;

        class App extends StyledComponent {
          init() {
            this.audioContext = null;
            this.visibilityStatus = !document.hidden ? "Page is visible" : "Page is hidden";
            this.visibilityColor = !document.hidden ? "#068806" : "#880606";

            this.initAudioContext();
            this.setupVisibilityListener();
          }

          initAudioContext() {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            this.audioContext = new AudioContext();
          }

          playChime(frequency, duration = 500) {
            if (!this.audioContext) return;

            if (this.audioContext.state === "suspended") {
              this.audioContext.resume();
            }

            const oscillator = this.audioContext.createOscillator();
            const gainNode = this.audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(this.audioContext.destination);

            oscillator.type = "sine";
            oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);

            gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + duration / 1000);

            oscillator.start(this.audioContext.currentTime);
            oscillator.stop(this.audioContext.currentTime + duration / 1000);
          }

          setupVisibilityListener() {
            document.addEventListener("visibilitychange", () => {
              if (document.hidden) {
                this.playChime(440, 300);
                this.visibilityStatus = "Page is hidden";
                this.visibilityColor = "#880606";
              } else {
                this.playChime(880, 300);
                this.visibilityStatus = "Page is visible";
                this.visibilityColor = "#068806";
              }
              this.render();
            });
          }

          styles() {
            return css`
              #status {
                font-size: 1.5em;
                color: ${this.visibilityColor};
                font-weight: bold;
              }
            `;
          }

          compose() {
            return vdom`
              <div>
                <h2>Page Visibility Status</h2>
                <p id="status">
                  ${this.visibilityStatus}
                </p>
                <p>
                  Switch to another tab or minimize this window to hear a low chime (440Hz).
                  Come back to hear a high chime (880Hz).
                </p>
                <button onclick=${() => {
                  this.playChime(660, 200);
                }}>Test Chime Sound</button>
              </div>
            `;
          }
        }

        const app = new App();
        document.getElementsByTagName("main")[0].appendChild(app.node);
      })();
    </script>
  </body>
</html>
